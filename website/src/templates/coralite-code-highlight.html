<template id="coralite-code-highlight">
  <div class="code">
    <div class="code-toolbar">
      <span class="code-language">{{ language }}</span>
      <button ref="popoverBtn" popovertarget="{{ popovertarget }}" type="button" class="button button-icon">
        Copy to clipboard
      </button>
      <div ref="popoverTarget" popover>Code copied!</div>
    </div>
    <pre ref="code" class="code-body"><code class="language-{{languageClass}}"><slot></slot></code></pre>
  </div>
</template>

<script type="module">
  import { defineComponent, parseHTML } from 'coralite'
  import code from 'highlight.js'
  import { indent, dedent } from '../utils/format.js'

  code.configure({
    classPrefix: 'code-'
  })

  const allowedCustomTags = ['coralite-version']

  function replacePlaceholders(nodes, placeholders) {
    const result = []

    for (let i = 0; i < nodes.length; i++) {
      const node = nodes[i]

      if (node.type === 'text') {
        const parts = node.data.split(/(__CORALITE_TAG_\d+__)/g)

        for (let j = 0; j < parts.length; j++) {
          const part = parts[j]
          if (placeholders[part]) {
            const originalNode = placeholders[part]
            originalNode.parent = node.parent
            result.push(originalNode)
          } else if (part) {
            result.push({
              type: 'text',
              data: part,
              parent: node.parent
            })
          }
        }
      } else if (node.children) {
        node.children = replacePlaceholders(node.children, placeholders)
        result.push(node)
      } else {
        result.push(node)
      }
    }
    return result
  }

  export default defineComponent({
    tokens: {
      languageClass(attributes) {
        return attributes.language.toLowerCase()
      }
    },
    slots: {
      default(content, values) {
        let fullText = ''
        const placeholders = {}
        let placeholderIndex = 0

        for (let i = 0; i < content.length; i++) {
          const node = content[i];

          if (node.type === 'text') {
            fullText += node.data
          } else if (node.type === 'tag' && allowedCustomTags.includes(node.name)) {
            const placeholder = `__CORALITE_TAG_${placeholderIndex++}__`
            placeholders[placeholder] = node
            fullText += placeholder
          }
        }

        const dedented = dedent(fullText).trim()
        // re-indent with 2 spaces relative to the tag
        const indentedContent = indent(dedented, '  ')

        const highlightCode = code.highlight(
          indentedContent,
          { language: values.language.toLowerCase() }
        )

        const nodes = parseHTML(highlightCode.value.trimEnd())

        return replacePlaceholders(nodes.root.children, placeholders)
      }
    },
    script(context, { refs }) {
      const popoverButton = refs('popoverBtn')
      const popoverTarget = refs('popoverTarget')
      const codeBody = refs('code')
      const popoverId = 'copy-' + Math.random().toString(16).substring(2)

      popoverTarget.setAttribute('id', popoverId)
      popoverButton.setAttribute('popovertarget', popoverId) 

      popoverButton.addEventListener('click', () => {
        navigator.clipboard.writeText(codeBody.textContent)
      })
    }
  })
</script>