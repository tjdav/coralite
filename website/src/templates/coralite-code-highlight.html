<template id="coralite-code-highlight">
  <div class="code">
    <div class="code-toolbar">
      <span class="code-language">{{ language }}</span>
      <button ref="popoverBtn" popovertarget="{{ popovertarget }}" type="button" class="button button-icon">
        Copy to clipboard
      </button>
      <div ref="popoverTarget" popover>Code copied!</div>
    </div>
    <pre ref="code" class="code-body"><code class="language-{{languageClass}}"><slot></slot></code></pre>
  </div>
</template>

<script type="module">
  import { defineComponent, parseHTML } from 'coralite'
  import code from 'highlight.js'

  code.configure({
    classPrefix: 'code-'
  })

  const allowedCustomTags = ['coralite-version']

  export default defineComponent({
    tokens: {
      languageClass(attributes) {
        return attributes.language.toLowerCase()
      }
    },
    slots: {
      default(content, values) {
        let result = []
        let endIndex = content.length
        let startIndex = 0
        const firstNode = content[0]
        const lastNode = content[endIndex - 1]

        if (firstNode.type === 'text' && !firstNode.data.trim()) {
          // skip first new line
          startIndex = 1
        }

        if (lastNode.type === 'text' && !lastNode.data.trim()) {
          endIndex = content.length - 1
        }

        for (let i = startIndex; i < endIndex; i++) {
          const node = content[i];

          if (node.type === 'text' && node.data.trim()) {
            const highlightCode = code.highlight(
              node.data,
              { language: values.language.toLowerCase() }
            )

            const nodes = parseHTML(highlightCode.value)

            result = result.concat(nodes.root.children)
          } else if (node.type === 'tag' && allowedCustomTags.includes(node.name)) {
            result.push(node)
          }
        }

        return result
      }
    },
    script(context, { refs }) {
      const popoverButton = refs('popoverBtn')
      const popoverTarget = refs('popoverTarget')
      const codeBody = refs('code')
      const popoverId = 'copy-' + Math.random().toString(16).substring(2)

      popoverTarget.setAttribute('id', popoverId)
      popoverButton.setAttribute('popovertarget', popoverId) 

      popoverButton.addEventListener('click', () => {
        navigator.clipboard.writeText(codeBody.textContent)
      })
    }
  })
</script>